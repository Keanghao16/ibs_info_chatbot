{% extends "master.html" %}

{% block title %}System Settings - Telegram Bot Admin{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="gradient-primary rounded-3xl shadow-2xl p-8 mb-8 text-white text-center">
        <h1 class="text-4xl font-bold mb-3 flex items-center justify-center gap-3">
            <i class="fas fa-cogs"></i>
            System Settings
        </h1>
        <p class="text-lg opacity-90">Manage FAQ categories and questions</p>
    </div>

    <!-- Settings Navigation -->
    <div class="bg-white rounded-2xl shadow-lg p-5 mb-8 flex flex-wrap gap-4">
        <button class="settings-nav-btn active px-4 py-2 bg-primary-500 text-white rounded-lg font-semibold transition-all hover:bg-primary-600 flex items-center gap-2"
                onclick="showSection('category', this)">
            <i class="fas fa-folder-open"></i>
            Categories
        </button>
        <button class="settings-nav-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-semibold transition-all hover:bg-gray-200 flex items-center gap-2"
                onclick="showSection('faq', this)">
            <i class="fas fa-question-circle"></i>
            FAQs
        </button>
    </div>

    <!-- Category Management Section -->
    <div class="settings-section bg-white rounded-2xl shadow-lg p-8 mb-8" id="category-section">
        <h2 class="text-3xl font-bold mb-5 text-gray-900 flex items-center gap-3">
            <i class="fas fa-folder-open text-primary-500"></i>
            Category Management
        </h2>
        <p class="text-gray-600 mb-8 text-lg">Manage FAQ categories to organize your questions</p>

        <div class="flex flex-wrap gap-4 mb-6">
            <button class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                    onclick="showAddCategoryModal()">
                <i class="fas fa-plus-circle"></i>
                Add New Category
            </button>
            <button class="px-6 py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl"
                    onclick="refreshCategories()">
                <i class="fas fa-refresh"></i>
                Refresh
            </button>
        </div>

        <div id="category-items" class="mt-5">
            <!-- Categories will be loaded here via API -->
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">Loading categories...</p>
            </div>
        </div>
    </div>

    <!-- FAQ Management Section -->
    <div class="settings-section bg-white rounded-2xl shadow-lg p-8 mb-8 hidden" id="faq-section">
        <h2 class="text-3xl font-bold mb-5 text-gray-900 flex items-center gap-3">
            <i class="fas fa-question-circle text-primary-500"></i>
            FAQ Management
        </h2>
        <p class="text-gray-600 mb-8 text-lg">Manage frequently asked questions for your users</p>

        <button class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-1 mb-5"
                onclick="showAddFAQModal()">
            <i class="fas fa-plus-circle"></i>
            Add New FAQ
        </button>

        <!-- Category Filter -->
        <div class="mb-5">
            <select class="px-4 py-2 border-2 border-gray-200 rounded-lg text-sm bg-white min-w-[150px] cursor-pointer transition-all focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100" 
                    id="categoryFilter" onchange="filterFAQsByCategory()">
                <option value="">All Categories</option>
                {% for category in categories %}
                <option value="{{ category.id }}">
                    {{ category.icon or 'üìÅ' }} {{ category.name }}
                </option>
                {% endfor %}
            </select>
            <span class="ml-4 text-gray-600">
                Total: <strong id="faqCount">{{ faqs|length }}</strong> FAQs
            </span>
        </div>

        <div id="faq-items" class="mt-5">
            {% if faqs and faqs|length > 0 %}
            {% for faq in faqs %}
            <div class="bg-gray-50 p-5 rounded-xl mb-4 border-l-4 border-primary-500 transition-all duration-200 hover:bg-gray-100 hover:translate-x-1 hover:shadow-md" 
                 data-id="{{ faq.id }}" 
                 data-category="{{ faq.category_id }}"
                 data-question="{{ faq.question|replace('"', '&quot;') }}" 
                 data-answer="{{ faq.answer|replace('"', '&quot;')|replace('\n', '&#10;') }}" 
                 data-order="{{ faq.order_index }}"
                 data-active="{{ 'true' if faq.is_active else 'false' }}" 
                 {% if not faq.is_active %}style="opacity: 0.6;"{% endif %}>
                <div class="flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <span class="inline-block w-2 h-2 rounded-full mr-2 {{ 'bg-green-500' if faq.is_active else 'bg-red-500' }}"></span>
                        <span class="font-semibold text-gray-900 text-base">{{ faq.question }}</span>
                        <span class="bg-gray-200 px-2 py-1 rounded-full text-xs ml-3">
                            {{ faq.category_icon }} {{ faq.category_name }}
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button class="px-3 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors font-semibold text-sm flex items-center gap-1"
                                onclick='editFAQById({{ faq.id }})' title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors font-semibold text-sm flex items-center gap-1"
                                onclick="deleteFAQ({{ faq.id }})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="text-gray-600 leading-relaxed whitespace-pre-wrap">{{ faq.answer }}</div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-16 text-gray-400">
                <i class="fas fa-question-circle text-6xl mb-4 opacity-30"></i>
                <h3 class="text-2xl font-bold text-gray-600 mb-2">No FAQs Available</h3>
                <p class="text-gray-500">Click "Add New FAQ" to create your first FAQ entry.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add/Edit FAQ Modal -->
<div id="faqModal" class="hidden fixed inset-0 bg-black/50 z-50 overflow-y-auto p-5 animate-fadeIn">
    <div class="bg-white my-5 mx-auto rounded-2xl w-[90%] max-w-2xl max-h-[calc(100vh-80px)] shadow-2xl flex flex-col animate-slideDown">
        <div class="flex justify-between items-center px-8 py-6 border-b-2 border-gray-200 rounded-t-2xl bg-white">
            <h3 id="modalTitle" class="m-0 text-gray-900 text-2xl flex items-center gap-3">
                <i class="fas fa-plus-circle text-primary-500"></i> Add New FAQ
            </h3>
            <button onclick="closeFAQModal()" class="text-gray-400 text-3xl font-bold cursor-pointer hover:text-gray-900 transition-colors">
                &times;
            </button>
        </div>

        <div class="px-8 py-6 overflow-y-auto flex-1 max-h-[calc(100vh-280px)] scrollbar-thin scrollbar-thumb-primary-500 scrollbar-track-gray-100">
            <form id="faqForm" method="POST" action="{{ url_for('system_settings.save_faq') }}">
                <input type="hidden" id="faq_id" name="faq_id">

                <div class="mb-6">
                    <label for="faq_question" class="block text-sm font-bold text-gray-700 mb-2">Question *</label>
                    <input type="text" id="faq_question" name="question" required
                           placeholder="Enter the FAQ question..."
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all">
                    <p class="text-xs text-gray-500 mt-1">
                        üí° Tip: Questions should end with a question mark (?)
                    </p>
                </div>

                <div class="mb-6">
                    <label for="faq_answer" class="block text-sm font-bold text-gray-700 mb-2">Answer *</label>
                    <textarea id="faq_answer" name="answer" required
                              placeholder="Enter the detailed answer..."
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all min-h-[120px] resize-y"></textarea>
                </div>

                <div class="mb-6">
                    <label for="faq_category" class="block text-sm font-bold text-gray-700 mb-2">Category</label>
                    <select id="faq_category" name="category_id"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all">
                        {% for category in categories %}
                        {% if category.is_active %}
                        <option value="{{ category.id }}">
                            {{ category.icon or 'üìÅ' }} {{ category.name }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-6">
                    <label for="order_index" class="block text-sm font-bold text-gray-700 mb-2">Display Order</label>
                    <input type="number" id="order_index" name="order_index" value="0" min="0"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all">
                    <small class="block text-gray-600 text-sm mt-2">Lower numbers appear first (0 = highest priority)</small>
                </div>

                <div class="flex items-center gap-4">
                    <label class="relative inline-block w-16 h-8">
                        <input type="checkbox" id="faq_active" name="is_active" checked
                               class="opacity-0 w-0 h-0 peer">
                        <span class="absolute cursor-pointer inset-0 bg-gray-300 rounded-full transition-all duration-400 before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition-all before:duration-400 peer-checked:bg-green-500 peer-checked:before:translate-x-8"></span>
                    </label>
                    <div>
                        <strong class="text-gray-900">Active</strong>
                        <p class="text-gray-600 text-sm m-0">Show this FAQ to users in the bot</p>
                    </div>
                </div>
            </form>
        </div>

        <div class="flex gap-3 justify-end px-8 py-6 border-t border-gray-200 rounded-b-2xl bg-white">
            <button type="button" onclick="closeFAQModal()" 
                    class="px-5 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition-all flex items-center gap-2">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" form="faqForm" 
                    class="px-5 py-3 bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-lg font-semibold hover:from-primary-600 hover:to-secondary-600 transition-all flex items-center gap-2 shadow-lg">
                <i class="fas fa-save"></i> Save FAQ
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div id="categoryModal" class="hidden fixed inset-0 bg-black/50 z-50 overflow-y-auto p-5 animate-fadeIn">
    <div class="bg-white my-5 mx-auto rounded-2xl w-[90%] max-w-2xl max-h-[calc(100vh-80px)] shadow-2xl flex flex-col animate-slideDown">
        <div class="flex justify-between items-center px-8 py-6 border-b-2 border-gray-200 rounded-t-2xl bg-white">
            <h3 id="categoryModalTitle" class="m-0 text-gray-900 text-2xl flex items-center gap-3">
                <i class="fas fa-plus-circle text-primary-500"></i> Add New Category
            </h3>
            <button onclick="closeCategoryModal()" class="text-gray-400 text-3xl font-bold cursor-pointer hover:text-gray-900 transition-colors">
                &times;
            </button>
        </div>

        <div class="px-8 py-6 overflow-y-auto flex-1 max-h-[calc(100vh-280px)] scrollbar-thin scrollbar-thumb-primary-500 scrollbar-track-gray-100">
            <form id="categoryForm" method="POST" action="{{ url_for('system_settings.save_category') }}">
                <input type="hidden" id="category_id" name="category_id">

                <div class="mb-6">
                    <label for="category_name" class="block text-sm font-bold text-gray-700 mb-2">Category Name *</label>
                    <input type="text" id="category_name" name="name" required
                           placeholder="e.g., Getting Started, Technical Support"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all">
                    <small class="block text-gray-600 text-sm mt-2">Display name for the category (slug will be auto-generated)</small>
                </div>

                <div class="mb-6">
                    <label for="category_icon" class="block text-sm font-bold text-gray-700 mb-2">Icon/Emoji</label>
                    <input type="text" id="category_icon" name="icon" value="üìÅ" placeholder="üìÅ"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all">
                    <small class="block text-gray-600 text-sm mt-2">Emoji or icon to represent this category</small>
                </div>

                <div class="mb-6">
                    <label for="category_description" class="block text-sm font-bold text-gray-700 mb-2">Description</label>
                    <textarea id="category_description" name="description"
                              placeholder="Brief description of this category..."
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all min-h-[120px] resize-y"></textarea>
                </div>

                <div class="mb-6">
                    <label for="category_order" class="block text-sm font-bold text-gray-700 mb-2">Display Order</label>
                    <input type="number" id="category_order" name="order_index" value="0" min="0"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all">
                    <small class="block text-gray-600 text-sm mt-2">Lower numbers appear first</small>
                </div>

                <div class="flex items-center gap-4">
                    <label class="relative inline-block w-16 h-8">
                        <input type="checkbox" id="category_active" name="is_active" checked
                               class="opacity-0 w-0 h-0 peer">
                        <span class="absolute cursor-pointer inset-0 bg-gray-300 rounded-full transition-all duration-400 before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition-all before:duration-400 peer-checked:bg-green-500 peer-checked:before:translate-x-8"></span>
                    </label>
                    <div>
                        <strong class="text-gray-900">Active</strong>
                        <p class="text-gray-600 text-sm m-0">Show this category to users</p>
                    </div>
                </div>
            </form>
        </div>

        <div class="flex gap-3 justify-end px-8 py-6 border-t border-gray-200 rounded-b-2xl bg-white">
            <button type="button" onclick="closeCategoryModal()" 
                    class="px-5 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition-all flex items-center gap-2">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" form="categoryForm" 
                    class="px-5 py-3 bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-lg font-semibold hover:from-primary-600 hover:to-secondary-600 transition-all flex items-center gap-2 shadow-lg">
                <i class="fas fa-save"></i> Save Category
            </button>
        </div>
    </div>
</div>

<script>
    // Section Navigation
    function showSection(sectionName, button) {
        // Hide all sections
        document.querySelectorAll('.settings-section').forEach(section => {
            section.classList.add('hidden');
        });

        // Remove active class from all nav buttons
        document.querySelectorAll('.settings-nav-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-primary-500', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
        });

        // Show selected section
        document.getElementById(`${sectionName}-section`).classList.remove('hidden');

        // Add active class to clicked button
        button.classList.add('active', 'bg-primary-500', 'text-white');
        button.classList.remove('bg-gray-100', 'text-gray-700');

        // Load categories when category section is shown
        if (sectionName === 'category') {
            loadCategories();
        }
    }

    // FAQ Functions
    function showAddFAQModal() {
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle text-primary-500"></i> Add New FAQ';
        document.getElementById('faqForm').reset();
        document.getElementById('faq_id').value = '';
        document.getElementById('faq_active').checked = true;
        document.getElementById('faqModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function editFAQById(faqId) {
        const faqElement = document.querySelector(`[data-id="${faqId}"]`);
        if (!faqElement) return;

        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit text-primary-500"></i> Edit FAQ';
        document.getElementById('faq_id').value = faqId;
        document.getElementById('faq_question').value = faqElement.dataset.question;
        document.getElementById('faq_answer').value = faqElement.dataset.answer.replace(/&#10;/g, '\n');
        document.getElementById('faq_category').value = faqElement.dataset.category;
        document.getElementById('order_index').value = faqElement.dataset.order || 0;
        document.getElementById('faq_active').checked = faqElement.dataset.active === 'true';
        document.getElementById('faqModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeFAQModal() {
        document.getElementById('faqModal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    function deleteFAQ(faqId) {
        if (confirm('Are you sure you want to delete this FAQ?')) {
            fetch(`/portal/admin/system-settings/delete-faq/${faqId}`, {
                method: 'DELETE',
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest'
                    // Removed Content-Type header - not needed for empty body
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-id="${faqId}"]`).remove();
                    showToast('FAQ Deleted', 'FAQ deleted successfully!', 'success');
                    updateFAQCount();
                } else {
                    showToast('Delete Failed', data.message || 'Failed to delete FAQ', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error', 'An error occurred while deleting the FAQ.', 'danger');
            });
        }
    }

    // Category Functions - Updated to use API
    let categoriesData = []; // Store categories data locally

    function showAddCategoryModal() {
        document.getElementById('categoryModalTitle').innerHTML = '<i class="fas fa-plus-circle text-primary-500"></i> Add New Category';
        document.getElementById('categoryForm').reset();
        document.getElementById('category_id').value = '';
        document.getElementById('category_active').checked = true;
        document.getElementById('categoryModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function editCategory(categoryId, categoryData) {
        document.getElementById('categoryModalTitle').innerHTML = '<i class="fas fa-edit text-primary-500"></i> Edit Category';
        document.getElementById('category_id').value = categoryId;
        document.getElementById('category_name').value = categoryData.name;
        document.getElementById('category_icon').value = categoryData.icon || 'üìÅ';
        document.getElementById('category_description').value = categoryData.description || '';
        document.getElementById('category_order').value = categoryData.order_index || 0;
        document.getElementById('category_active').checked = categoryData.is_active;
        document.getElementById('categoryModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    function deleteCategory(categoryId) {
        if (confirm('Are you sure you want to delete this category?\n\nNote: You cannot delete categories that have FAQs assigned to them.')) {
            fetch(`/portal/admin/system-settings/delete-category/${categoryId}`, {
                method: 'DELETE',
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest'
                    // Removed Content-Type header - not needed for empty body
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Category Deleted', 'Category deleted successfully!', 'success');
                    loadCategories(); // Reload categories
                } else {
                    showToast('Delete Failed', data.message || 'Failed to delete category', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error', 'An error occurred while deleting the category.', 'danger');
            });
        }
    }

    function loadCategories() {
        const container = document.getElementById('category-items');
        container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i><p class="text-gray-500">Loading categories...</p></div>';

        fetch('/portal/admin/system-settings/api/categories', {
            headers: { 
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                categoriesData = data.categories;
                renderCategories(data.categories);
            } else {
                container.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-3xl mb-4"></i><p>Failed to load categories: ' + data.message + '</p></div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-3xl mb-4"></i><p>Error loading categories</p></div>';
        });
    }

    function renderCategories(categories) {
        const container = document.getElementById('category-items');
        
        if (!categories || categories.length === 0) {
            container.innerHTML = `
                <div class="text-center py-16 text-gray-400">
                    <i class="fas fa-folder-open text-6xl mb-4 opacity-30"></i>
                    <h3 class="text-2xl font-bold text-gray-600 mb-2">No Categories Available</h3>
                    <p class="text-gray-500">Click "Add New Category" to create your first FAQ category.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = categories.map(category => `
            <div class="bg-gray-50 p-5 rounded-xl mb-4 border-l-4 border-primary-500 transition-all duration-200 hover:bg-gray-100 hover:translate-x-1 hover:shadow-md" 
                 data-id="${category.id}" 
                 data-slug="${category.slug}" 
                 ${!category.is_active ? 'style="opacity: 0.6;"' : ''}>
                <div class="flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <span class="inline-block w-2 h-2 rounded-full mr-2 ${category.is_active ? 'bg-green-500' : 'bg-red-500'}"></span>
                        <span class="text-xl mr-2">${category.icon || 'üìÅ'}</span>
                        <span class="font-semibold text-gray-900 text-base">${category.name}</span>
                        <span class="bg-gray-200 px-2 py-1 rounded-full text-xs ml-3">
                            ${category.faq_count || 0} FAQ(s)
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button class="px-3 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors font-semibold text-sm flex items-center gap-1"
                                onclick='editCategory(${category.id}, ${JSON.stringify(category)})' title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors font-semibold text-sm flex items-center gap-1"
                                onclick="deleteCategory('${category.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${category.description ? `<div class="text-gray-600 leading-relaxed whitespace-pre-wrap">${category.description}</div>` : ''}
                <div class="mt-3 text-gray-500 text-sm">
                    <strong>Slug:</strong> ${category.slug} |
                    <strong>Order:</strong> ${category.order_index || 0}
                </div>
            </div>
        `).join('');
    }

    function refreshCategories() {
        loadCategories();
        showToast('üîÑ Refreshed', 'Categories refreshed successfully', 'info');
    }

    // Form submission handling - Updated for API
    document.getElementById('faqForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('FAQ Saved', 'FAQ saved successfully!', 'success');
                closeFAQModal();
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Save Failed', data.message || 'Failed to save FAQ', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'An error occurred while saving the FAQ.', 'danger');
        });
    });

    // Category form submission - Updated for API
    document.getElementById('categoryForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Category Saved', 'Category saved successfully!', 'success');
                closeCategoryModal();
                loadCategories(); // Reload categories instead of full page reload
            } else {
                showToast('Save Failed', data.message || 'Failed to save category', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'An error occurred while saving the category.', 'danger');
        });
    });

    // Note: Using global showToast() function from master.html

    // Helper functions
    function updateFAQCount() {
        const visibleFAQs = document.querySelectorAll('#faq-items > div:not([style*="display: none"])').length;
        document.getElementById('faqCount').textContent = visibleFAQs;
    }

    function filterFAQsByCategory() {
        const categoryId = document.getElementById('categoryFilter').value;
        const faqItems = document.querySelectorAll('#faq-items > div');
        let visibleCount = 0;
        faqItems.forEach(item => {
            if (!categoryId || item.dataset.category === categoryId) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        document.getElementById('faqCount').textContent = visibleCount;
    }

    // Close modals when clicking outside
    window.onclick = function (event) {
        const faqModal = document.getElementById('faqModal');
        const categoryModal = document.getElementById('categoryModal');
        if (event.target == faqModal) closeFAQModal();
        if (event.target == categoryModal) closeCategoryModal();
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            if (document.getElementById('faqModal').classList.contains('hidden') === false) {
                closeFAQModal();
            }
            if (document.getElementById('categoryModal').classList.contains('hidden') === false) {
                closeCategoryModal();
            }
        }
    });

    // Initialize page - Load categories on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load categories by default since it's the first visible section
        loadCategories();
    });

    function saveFAQ() {
        const question = document.getElementById('faq_question').value.trim();
        const answer = document.getElementById('faq_answer').value.trim();
        
        // Validate question mark
        if (!question.endsWith('?')) {
            showToast('‚ö†Ô∏è Validation Error', 'Questions should end with a question mark (?)', 'warning');
            return;
        }
        
        // Validate minimum lengths
        if (question.length < 5) {
            showToast('‚ö†Ô∏è Validation Error', 'Question must be at least 5 characters long', 'warning');
            return;
        }
        
        if (answer.length < 10) {
            showToast('‚ö†Ô∏è Validation Error', 'Answer must be at least 10 characters long', 'warning');
            return;
        }
        
        // Continue with save...
    }
</script>
{% endblock %}
{% extends "master.html" %}

{% block extra_head %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-5 h-[calc(100vh-100px)] m-5 max-w-full">
    <!-- Chat List Sidebar -->
    <div class="bg-white rounded-2xl p-5 overflow-y-auto shadow-lg">
        <h3 class="text-xl font-bold text-gray-900 mb-3 pb-3 border-b-2 border-primary-500 flex items-center gap-2">
            <i class="fas fa-comments text-primary-500"></i> 
            <span id="chatListTitle">Active Chats</span> (<span id="chatCount">{{ sessions|length }}</span>)
        </h3>
        
        <!-- Status Filter Toggle -->
        <div class="mb-4 flex gap-2">
            <button onclick="switchChatFilter('active')" id="filter-active" 
                    class="flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-blue-100 text-blue-700 border-2 border-blue-500">
                üí¨ Active
            </button>
            <button onclick="switchChatFilter('closed')" id="filter-closed"
                    class="flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 border-2 border-gray-300 hover:bg-gray-200">
                ‚úÖ Closed
            </button>
        </div>
        
        <!-- Chat List Container - Always present -->
        <div id="chatListItems" class="space-y-3">
        {% if sessions and sessions|length > 0 %}
                {% for session in sessions %}
                <div class="chat-item p-4 border-2 border-gray-200 rounded-xl hover:border-primary-500 cursor-pointer transition-all duration-300 hover:shadow-md"
                     data-session-id="{{ session.id }}"
                     data-user-name="{{ session.user_name or 'Unknown User' }}"
                     data-user-id="{{ session.user_id }}"
                     data-status="{{ session.status }}"
                     onclick="selectChat({{ session.id }}, '{{ session.user_name or 'Unknown User' }}', '{{ session.user_id }}', '{{ (session.user_name or 'U')[0]|upper }}', '{{ session.status }}')">
                    
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm shadow-md">
                            {{ (session.user_name or 'U')[0]|upper }}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-gray-900 truncate">{{ session.user_name or 'Unknown User' }}</h4>
                            <div class="text-xs text-gray-600">ID: {{ session.user_id[:8] }}...</div>
                        </div>
                        {% if session.status == 'waiting' %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
                            <i class="fas fa-clock animate-pulse"></i> Waiting
                        </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                            <i class="fas fa-circle animate-pulse"></i> Active
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="text-sm text-gray-600 truncate">
                        Started: {{ session.start_time | cambodia_time if session.start_time else 'Unknown' }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-10 text-gray-400">
                    <i class="fas fa-comments-slash text-3xl mb-3"></i>
                    <p>No active chats</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Chat Window -->
    <div class="bg-white rounded-2xl flex flex-col shadow-lg overflow-hidden">
        <!-- Chat Header -->
        <div class="chat-header gradient-primary text-white p-6 border-b-2 border-white/10" id="chatHeader">
            <div class="flex flex-col items-center justify-center h-full text-center py-16">
                <i class="fas fa-comments text-6xl mb-4 opacity-50"></i>
                <h3 class="text-2xl font-bold mb-2">Select a chat to start</h3>
                <p class="text-lg opacity-90">Choose a chat session from the sidebar</p>
            </div>
        </div>
        
        <!-- Messages Container -->
        <div class="messages-container flex-1 p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-white flex flex-col gap-4 hidden" 
             id="messagesContainer">
            <!-- Messages will be loaded here -->
        </div>
        
        <!-- Message Input -->
        <div class="message-input p-6 border-t-2 border-gray-100 flex gap-3 bg-white hidden" 
             id="messageInputContainer">
            <input type="text" 
                   id="messageInput"
                   placeholder="Type your message..."
                   class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all"
                   onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" 
                    class="px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl font-semibold hover:from-primary-600 hover:to-primary-700 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center gap-2">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
    </div>
</div>

<style>
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }
    .messages-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .messages-container::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }
    .messages-container::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }

    .chat-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
        border-color: #667eea !important;
        border-width: 3px !important;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-wrapper {
        animation: slideIn 0.3s ease-out;
    }
</style>

<script>
    const socket = io();
    let currentSessionId = null;
    let currentUserName = '';
    let currentTelegramId = null;
    let currentUserAvatar = 'U';
    let currentSessionStatus = '';
    
    const currentAdminName = '{{ session.admin.full_name or "Admin" }}';
    const currentAdminId = '{{ session.admin.id }}';
    const preselectSessionId = {% if preselect_session_id %}{{ preselect_session_id }}{% else %}null{% endif %};
    
    socket.on('connect', () => {
        console.log('‚úÖ Connected to WebSocket');
        
        // Auto-select session if provided in URL
        if (preselectSessionId) {
            setTimeout(() => {
                autoSelectSession(preselectSessionId);
            }, 500);
        }
    });
    
    socket.on('disconnect', () => {
        console.log('‚ùå Disconnected from WebSocket');
    });
    
    socket.on('new_message', function(data) {
        console.log('üì© New message received:', data);
        if (data.session_id == currentSessionId) {
            appendMessage(data.message, false, data.timestamp);
        }
        updateChatPreview(data.session_id, data.message);
        
        // Update notification badges
        if (window.updateNotificationBadges) {
            fetchSessionCounts();
        }
    });
    
    socket.on('message_sent', data => {
        console.log('‚úâÔ∏è Message sent confirmation:', data);
        appendMessage(data.message, true, data.timestamp);
    });
    
    socket.on('error', data => {
        console.error('‚ö†Ô∏è Socket error:', data);
        alert('Error: ' + data.message);
    });
    
    // Handle new waiting sessions
    socket.on('new_waiting_session', function(data) {
        console.log('üîî New waiting session:', data);
        
        // Show notification
        showNotification(`New chat from ${data.user_name}`, 'info');
        
        // Update badges
        if (window.updateNotificationBadges) {
            fetchSessionCounts();
        }
        
        // Reload to show new session
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });
    
    // Handle session assignments
    socket.on('session_assigned', function(data) {
        console.log('üë§ Session assigned:', data);
        const chatItem = document.querySelector(`[data-session-id="${data.session_id}"] .status-badge`);
        if (chatItem) {
            chatItem.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800';
            chatItem.innerHTML = '<i class="fas fa-circle animate-pulse"></i> Active';
        }
    });
    
    // Handle session closures
    socket.on('session_closed', function(data) {
        console.log('üîí Session closed:', data);
        const chatItem = document.querySelector(`[data-session-id="${data.session_id}"]`);
        if (chatItem) {
            chatItem.style.opacity = '0.5';
        }
    });
    
    // Notification helper function
    function showNotification(message, type = 'info') {
        // Browser notification
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('IBS Chat System', {
                body: message,
                icon: '/static/favicon.ico'
            });
        }
        
        // Console log
        console.log(`üîî ${type.toUpperCase()}: ${message}`);
        
        // Optional: Add visual notification banner
        const banner = document.createElement('div');
        banner.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce';
        banner.textContent = message;
        document.body.appendChild(banner);
        
        setTimeout(() => {
            banner.remove();
        }, 5000);
    }
    
    // Request notification permission on page load
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    function selectChat(sessionId, userName, userId, userAvatar, status) {
        currentSessionId = sessionId;
        currentUserName = userName;
        currentTelegramId = userId;
        currentUserAvatar = userAvatar || 'U';
        currentSessionStatus = status;
        
        console.log(`üì± Selected chat: Session ${sessionId}, User: ${userName}, Status: ${status}`);
        
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        const selectedItem = document.querySelector(`[data-session-id="${sessionId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }
        
        let statusBadge = '';
        if (status === 'closed') {
            statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-gray-400/20 text-gray-300"><i class="fas fa-check-circle"></i> Closed</span>';
        } else if (status === 'waiting') {
            statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-yellow-400/20 text-yellow-200"><i class="fas fa-clock animate-pulse"></i> Waiting</span>';
        } else {
            statusBadge = '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-green-400/20 text-green-200"><i class="fas fa-circle animate-pulse"></i> Active</span>';
        }
        
        document.getElementById('chatHeader').innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                        ${userAvatar}
                    </div>
                    <div>
                        <h4 class="text-2xl font-bold m-0">${escapeHtml(userName)}</h4>
                        <p class="mt-1 opacity-90 text-sm">ID: ${escapeHtml(userId.substring(0, 8))}...</p>
                    </div>
                </div>
                ${statusBadge}
            </div>
        `;
        
        document.getElementById('messagesContainer').classList.remove('hidden');
        document.getElementById('messagesContainer').classList.add('flex');
        
        // Handle message input based on status
        const messageInputContainer = document.getElementById('messageInputContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = messageInputContainer.querySelector('button');
        
        if (status === 'closed') {
            // Disable input for closed sessions
            messageInputContainer.classList.remove('hidden');
            messageInputContainer.classList.add('flex');
            messageInput.disabled = true;
            messageInput.placeholder = 'This chat is closed';
            messageInput.className = 'flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl bg-gray-100 text-gray-500 cursor-not-allowed';
            sendButton.disabled = true;
            sendButton.className = 'px-6 py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed flex items-center gap-2';
        } else {
            // Enable input for active/waiting sessions
            messageInputContainer.classList.remove('hidden');
            messageInputContainer.classList.add('flex');
            messageInput.disabled = false;
            messageInput.placeholder = 'Type your message...';
            messageInput.className = 'flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all';
            sendButton.disabled = false;
            sendButton.className = 'px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl font-semibold hover:from-primary-600 hover:to-primary-700 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center gap-2';
        }
        
        if (status === 'waiting') {
            assignSessionToMe(sessionId);
        }
        
        loadMessages(sessionId);
    }
    
    function assignSessionToMe(sessionId) {
        console.log(`üîÑ Auto-assigning session ${sessionId} to current admin`);
        
        fetch(`/portal/admin/chat/assign/${sessionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Session assigned successfully');
                currentSessionStatus = 'active';
                const statusBadge = document.querySelector('.chat-header span');
                if (statusBadge) {
                    statusBadge.className = 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-green-400/20 text-green-200';
                    statusBadge.innerHTML = '<i class="fas fa-circle animate-pulse"></i> Active';
                }
                const chatItem = document.querySelector(`[data-session-id="${sessionId}"] span`);
                if (chatItem) {
                    chatItem.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800';
                    chatItem.innerHTML = '<i class="fas fa-circle animate-pulse"></i> Active';
                }
            } else {
                console.error('‚ùå Failed to assign session:', data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Error assigning session:', error);
        });
    }
    
    function loadMessages(sessionId) {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '<div class="text-center py-5 text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i><div class="mt-2">Loading messages...</div></div>';
        
        console.log(`üì• Loading messages for session ${sessionId}...`);
        
        fetch(`/portal/admin/chat/${sessionId}/messages`)
            .then(response => {
                console.log('üì° Messages API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìä Messages data:', data);
                container.innerHTML = '';
                
                if (data.success && data.data && data.data.length > 0) {
                    console.log(`‚úÖ Loaded ${data.data.length} messages`);
                    console.log('First message structure:', data.data[0]);
                    data.data.forEach(msg => {
                        console.log('Message admin info:', { admin_id: msg.admin_id, admin_name: msg.admin_name });
                        appendMessage(
                            msg.message, 
                            msg.is_from_admin, 
                            msg.timestamp,
                            msg.admin_name || msg.admin_id
                        );
                    });
                    container.scrollTop = container.scrollHeight;
                } else {
                    console.log('üì≠ No messages found');
                    container.innerHTML = '<div class="text-center py-10 text-gray-400"><i class="fas fa-inbox text-4xl mb-3"></i><div>No messages yet</div><div class="text-sm mt-2">Send a message to start the conversation</div></div>';
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading messages:', error);
                container.innerHTML = `<div class="text-center py-5 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><div>Error loading messages</div><div class="text-sm mt-1">${escapeHtml(error.message)}</div></div>`;
            });
    }
    
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !currentSessionId) {
            console.warn('‚ö†Ô∏è Cannot send: message or session missing');
            return;
        }
        
        console.log(`üì§ Sending message to session ${currentSessionId}:`, message);
        
        socket.emit('send_message', {
            session_id: currentSessionId,
            message: message
        });
        
        input.value = '';
        input.focus();
    }
    
    function appendMessage(text, isFromAdmin, timestamp, adminName = null) {
        const container = document.getElementById('messagesContainer');
        if (!container) return;
        
        const placeholder = container.querySelector('.text-center.py-10');
        if (placeholder) {
            placeholder.remove();
        }
        
        // Convert UTC timestamp to Cambodia time (UTC+7)
        const time = timestamp ? new Date(timestamp) : new Date();
        
        // No timezone conversion needed - database already in Cambodia time
        const timeStr = time.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false
        });
        
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper flex mb-3 ${isFromAdmin ? 'justify-end' : 'justify-start'}`;
        
        const avatar = document.createElement('div');
        avatar.className = `w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
            isFromAdmin 
                ? 'order-1 ml-3 bg-gradient-to-br from-purple-500 to-pink-500' 
                : 'order-[-1] mr-3 bg-gradient-to-br from-blue-500 to-cyan-500'
        } text-white shadow-md`;
        avatar.textContent = isFromAdmin ? (adminName ? adminName[0].toUpperCase() : 'A') : currentUserAvatar;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `max-w-[70%] px-4 py-3 rounded-2xl shadow-md ${
            isFromAdmin 
                ? 'bg-gradient-to-br from-purple-500 to-pink-500 text-white rounded-br-sm'
                : 'bg-white border-2 border-gray-200 text-gray-800 rounded-bl-sm'
        }`;
        
        const senderLabel = isFromAdmin && adminName 
            ? `<div class="font-bold text-xs uppercase tracking-wide opacity-90 mb-1">${escapeHtml(adminName)}</div>`
            : !isFromAdmin 
                ? `<div class="font-semibold text-xs uppercase tracking-wide opacity-75 mb-1 text-blue-600">${escapeHtml(currentUserName)}</div>`
                : '';
        
        messageDiv.innerHTML = `
            ${senderLabel}
            <div class="text-sm leading-relaxed whitespace-pre-wrap break-words">${escapeHtml(text)}</div>
            <div class="text-xs ${isFromAdmin ? 'opacity-80' : 'opacity-60'} text-right mt-2">${timeStr}</div>
        `;
        
        messageWrapper.appendChild(avatar);
        messageWrapper.appendChild(messageDiv);
        container.appendChild(messageWrapper);
        container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function updateChatPreview(sessionId, message) {
        const chatItem = document.querySelector(`[data-session-id="${sessionId}"]`);
        if (chatItem) {
            const preview = chatItem.querySelector('.text-sm.text-gray-600');
            if (preview) {
                const shortMsg = message.length > 40 ? message.substring(0, 40) + '...' : message;
                preview.textContent = 'Last: ' + shortMsg;
            }
        }
    }
    
    // Helper function to fetch session counts
    function fetchSessionCounts() {
        fetch('/portal/admin/api/session-counts')
            .then(response => response.json())
            .then(data => {
                if (data.success && window.updateNotificationBadges) {
                    window.updateNotificationBadges(data.waiting_count || 0, data.active_count || 0);
                }
            })
            .catch(error => console.error('Error fetching session counts:', error));
    }
    
    // Auto-select a specific session (called when coming from another page)
    function autoSelectSession(sessionId) {
        console.log('üéØ Auto-selecting session:', sessionId);
        
        // Find the chat item in the sidebar
        const chatItem = document.querySelector(`[data-session-id="${sessionId}"]`);
        
        if (chatItem) {
            // Extract data from the chat item
            const userName = chatItem.querySelector('.chat-user-name')?.textContent || 'User';
            const userId = chatItem.querySelector('.chat-user-info')?.getAttribute('data-telegram-id') || null;
            const status = chatItem.getAttribute('data-status') || 'active';
            
            // Click the chat item to select it
            chatItem.click();
            
            console.log('‚úÖ Session auto-selected:', {sessionId, userName, status});
        } else {
            console.warn('‚ö†Ô∏è Session not found in sidebar:', sessionId);
            // Try to load the session directly via API
            loadSessionDirectly(sessionId);
        }
    }
    
    // Load a session directly from API if not in sidebar
    function loadSessionDirectly(sessionId) {
        fetch(`/portal/admin/api/chat-session/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.session) {
                    const session = data.session;
                    selectChat(
                        session.id,
                        session.user?.full_name || 'User',
                        session.user?.telegram_id,
                        session.user?.username?.[0]?.toUpperCase() || 'U',
                        session.status
                    );
                } else {
                    alert('Chat session not found or no longer available');
                }
            })
            .catch(error => {
                console.error('Error loading session:', error);
                alert('Failed to load chat session');
            });
    }
    
    // Switch between active and closed chats
    let currentFilter = 'active';
    
    function switchChatFilter(filterType) {
        if (currentFilter === filterType) return;
        
        currentFilter = filterType;
        
        // Update button styles
        const activeBtn = document.getElementById('filter-active');
        const closedBtn = document.getElementById('filter-closed');
        
        if (filterType === 'active') {
            activeBtn.className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-blue-100 text-blue-700 border-2 border-blue-500';
            closedBtn.className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 border-2 border-gray-300 hover:bg-gray-200';
        } else {
            activeBtn.className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 border-2 border-gray-300 hover:bg-gray-200';
            closedBtn.className = 'flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-green-100 text-green-700 border-2 border-green-500';
        }
        
        // Fetch sessions based on filter
        fetchSessionsByStatus(filterType);
    }
    
    function fetchSessionsByStatus(status) {
        const url = status === 'closed' 
            ? '/portal/admin/api/chats?status=closed&page=1&per_page=50'
            : '/portal/admin/api/chats?status=active&page=1&per_page=50'; // Active sessions only
        
        console.log('Fetching sessions from:', url);
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('Full API Response:', data);
                console.log('data.success:', data.success);
                console.log('data.data:', data.data);
                
                if (data.success && data.data) {
                    // Try different possible paths for sessions
                    const sessions = data.data.sessions || data.data.items || data.data || [];
                    console.log('Sessions array:', sessions);
                    console.log('Sessions length:', sessions.length);
                    
                    // Log first session structure for debugging
                    if (sessions.length > 0) {
                        console.log('First session structure:', sessions[0]);
                        console.log('First session user:', sessions[0].user);
                    }
                    
                    displaySessionsInSidebar(sessions, status);
                } else {
                    console.error('Failed to fetch sessions:', data);
                    displaySessionsInSidebar([], status);
                }
            })
            .catch(error => {
                console.error('Error fetching sessions:', error);
                displaySessionsInSidebar([], status);
            });
    }
    
    function displaySessionsInSidebar(sessions, filterType) {
        console.log('displaySessionsInSidebar called with:', { sessionsCount: sessions.length, filterType });
        
        // Update title and count
        const title = filterType === 'closed' ? 'Closed Chats' : 'Active Chats';
        document.getElementById('chatListTitle').textContent = title;
        document.getElementById('chatCount').textContent = sessions.length;
        
        // Get chat list container - use the ID directly
        const chatListContainer = document.getElementById('chatListItems');
        
        if (!chatListContainer) {
            console.error('Chat list container not found!');
            return;
        }
        
        console.log('Chat list container found:', chatListContainer);
        
        if (sessions.length === 0) {
            chatListContainer.innerHTML = `
                <div class="text-center py-10 text-gray-400">
                    <i class="fas fa-inbox text-5xl mb-3 opacity-50"></i>
                    <p class="text-lg">No ${filterType} chats</p>
                </div>
            `;
            return;
        }
        
        // Build sessions HTML
        let sessionsHTML = sessions.map(session => {
            // API returns user_name directly in session object, not nested
            const userName = session.user_name || 'Unknown User';
            const userAvatar = (session.user_name || 'U').charAt(0).toUpperCase();
            const telegramId = session.user_id || '';
            const status = session.status || 'waiting';
            
            // Escape for safe HTML insertion
            const safeUserName = userName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeTelegramId = String(telegramId);
            
            let statusBadge = '';
            let statusIcon = '';
            
            if (status === 'closed') {
                statusBadge = '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600"><i class="fas fa-check-circle"></i> Closed</span>';
                statusIcon = '‚úÖ';
            } else if (status === 'active') {
                statusBadge = '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800"><i class="fas fa-circle animate-pulse"></i> Active</span>';
                statusIcon = 'üí¨';
            } else {
                statusBadge = '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800"><i class="fas fa-clock animate-pulse"></i> Waiting</span>';
                statusIcon = '‚è≥';
            }
            
            const lastMessage = session.last_message || 'No messages yet';
            const safeLastMessage = lastMessage.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const lastMessageTime = session.last_message_time ? new Date(session.last_message_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
            
            return `
                <div class="chat-item p-4 rounded-xl border-2 border-gray-200 hover:border-primary-400 hover:shadow-lg transition-all duration-200 cursor-pointer ${status === 'closed' ? 'opacity-70' : ''}"
                     data-session-id="${session.id}"
                     data-status="${status}"
                     onclick="selectChat(${session.id}, '${safeUserName}', '${safeTelegramId}', '${userAvatar}', '${status}')">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-md flex-shrink-0">
                            ${userAvatar}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <h5 class="font-bold text-gray-900 text-sm truncate">${statusIcon} ${userName}</h5>
                                ${lastMessageTime ? `<span class="text-xs text-gray-500">${lastMessageTime}</span>` : ''}
                            </div>
                            ${statusBadge}
                            <p class="text-xs text-gray-600 truncate mt-2">${safeLastMessage.substring(0, 50)}${safeLastMessage.length > 50 ? '...' : ''}</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        chatListContainer.innerHTML = sessionsHTML;
    }
</script>
{% endblock %}
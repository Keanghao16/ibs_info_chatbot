{% extends "master.html" %}

{% block extra_head %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-5 h-[calc(100vh-100px)] m-5 max-w-full">
    <!-- Chat List Sidebar -->
    <div class="bg-white rounded-2xl p-5 overflow-y-auto shadow-lg">
        <h3 class="text-xl font-bold text-gray-900 mb-5 pb-3 border-b-2 border-primary-500 flex items-center gap-2">
            <i class="fas fa-comments text-primary-500"></i> 
            Active Chats ({{ sessions|length }})
        </h3>
        
        {% if sessions and sessions|length > 0 %}
            <div id="chatListItems" class="space-y-3">
                {% for session in sessions %}
                <div class="chat-item p-4 border-2 border-gray-200 rounded-xl hover:border-primary-500 cursor-pointer transition-all duration-300 hover:shadow-md"
                     data-session-id="{{ session.id }}"
                     onclick="selectChat({{ session.id }}, '{{ session.user_name or 'Unknown User' }}', '{{ session.user_id }}', '{{ (session.user_name or 'U')[0]|upper }}')">
                    
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm shadow-md">
                            {{ (session.user_name or 'U')[0]|upper }}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-gray-900 truncate">{{ session.user_name or 'Unknown User' }}</h4>
                            <div class="text-xs text-gray-600">ID: {{ session.user_id }}</div>
                        </div>
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                            <i class="fas fa-circle animate-pulse"></i> Active
                        </span>
                    </div>
                    
                    <div class="text-sm text-gray-600 truncate">
                        Started: {{ session.start_time | safe_datetime if session.start_time else 'Unknown' }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-10 text-gray-400">
                <i class="fas fa-comments-slash text-3xl mb-3"></i>
                <p>No active chats</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Chat Window -->
    <div class="bg-white rounded-2xl flex flex-col shadow-lg overflow-hidden">
        <!-- Chat Header -->
        <div class="chat-header gradient-primary text-white p-6 border-b-2 border-white/10" id="chatHeader">
            <div class="flex flex-col items-center justify-center h-full text-center py-16">
                <i class="fas fa-comments text-6xl mb-4 opacity-50"></i>
                <h3 class="text-2xl font-bold mb-2">Select a chat to start</h3>
                <p class="text-lg opacity-90">Choose a chat session from the sidebar</p>
            </div>
        </div>
        
        <!-- Messages Container -->
        <div class="messages-container flex-1 p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-white flex flex-col gap-4 hidden" 
             id="messagesContainer">
            <!-- Messages will be loaded here -->
        </div>
        
        <!-- Message Input -->
        <div class="message-input p-6 border-t-2 border-gray-100 flex gap-3 bg-white hidden" 
             id="messageInputContainer">
            <input type="text" 
                   id="messageInput"
                   placeholder="Type your message..."
                   class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all"
                   onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" 
                    class="px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl font-semibold hover:from-primary-600 hover:to-primary-700 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center gap-2">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
    </div>
</div>

<style>
    /* Custom scrollbar */
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }
    .messages-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .messages-container::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }
    .messages-container::-webkit-scrollbar-thumb:hover {
        background: #5568d3;
    }

    /* Chat item active state */
    .chat-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
        border-left-color: #667eea;
    }

    /* Message animation */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-wrapper {
        animation: slideIn 0.3s ease-out;
    }
</style>

<script>
    const socket = io();
    let currentSessionId = null;
    let currentUserName = '';
    let currentTelegramId = null;
    let currentUserAvatar = 'U';
    
    //  Fixed: Get current admin info from session
    const currentAdminName = '{{ session.admin.full_name or session.admin.telegram_first_name or "Admin" }}';
    
    document.addEventListener('DOMContentLoaded', function() {
        const chatListItems = document.getElementById('chatListItems');
        
        if (chatListItems) {
            chatListItems.addEventListener('click', function(e) {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    const sessionId = chatItem.dataset.sessionId;
                    const userName = chatItem.querySelector('h4').textContent;
                    const userAvatar = chatItem.querySelector('.w-10').textContent;
                    selectChat(sessionId, userName, '', userAvatar);
                }
            });
        }
    });
    
    socket.on('connect', () => console.log('Connected to WebSocket'));
    
    socket.on('new_message', function(data) {
        if (data.session_id == currentSessionId) {
            appendMessage(data.message, false, data.timestamp);
        }
        updateChatPreview(data.session_id, data.message);
    });
    
    socket.on('message_sent', data => appendMessage(data.message, true, data.timestamp));
    socket.on('error', data => alert('Error: ' + data.message));
    
    function selectChat(sessionId, userName, telegramId, userAvatar) {
        currentSessionId = sessionId;
        currentUserName = userName;
        currentTelegramId = telegramId;
        currentUserAvatar = userAvatar || 'U';
        
        // Update active state
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`[data-session-id="${sessionId}"]`)?.classList.add('active');
        
        // Update header
        document.getElementById('chatHeader').innerHTML = `
            <h4 class="text-2xl font-bold flex items-center gap-3 m-0">
                <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-white font-bold text-lg">
                    ${userAvatar}
                </div>
                ${userName}
            </h4>
            <p class="mt-2 opacity-90 text-base">
                <i class="fas fa-circle animate-pulse text-green-300"></i> Active conversation
            </p>
        `;
        
        // Show containers
        document.getElementById('messagesContainer').classList.remove('hidden');
        document.getElementById('messagesContainer').classList.add('flex');
        document.getElementById('messageInputContainer').classList.remove('hidden');
        document.getElementById('messageInputContainer').classList.add('flex');
        
        loadMessages(sessionId);
    }
    
    function loadMessages(sessionId) {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '<div class="text-center py-5 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
        
        fetch(`/portal/admin/chat/${sessionId}/messages`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';
                if (data.success && data.messages) {
                    data.messages.forEach(msg => {
                        appendMessage(msg.message, msg.is_from_admin, msg.timestamp, msg.admin_name);
                    });
                } else {
                    container.innerHTML = '<div class="text-center py-5 text-gray-500">No messages yet</div>';
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                container.innerHTML = `<div class="text-center py-5 text-red-500">Error: ${error.message}</div>`;
            });
    }
    
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !currentSessionId) return;
        
        socket.emit('send_message', {
            session_id: currentSessionId,
            message: message
        });
        
        input.value = '';
        input.focus();
    }
    
    function appendMessage(text, isFromAdmin, timestamp, adminName = null) {
        const container = document.getElementById('messagesContainer');
        if (!container) return;
        
        const time = new Date(timestamp);
        const timeStr = time.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false
        });
        
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper flex mb-3 ${isFromAdmin ? 'justify-end' : 'justify-start'}`;
        
        const avatar = document.createElement('div');
        avatar.className = `w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
            isFromAdmin ? 'order-1 ml-3 bg-gradient-to-br from-secondary-500 to-primary-500' : 'order-[-1] mr-3 bg-gradient-to-br from-blue-400 to-blue-600'
        } text-white shadow-md`;
        avatar.textContent = isFromAdmin ? (adminName ? adminName[0].toUpperCase() : 'A') : currentUserAvatar;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `max-w-[65%] px-5 py-3 rounded-2xl shadow-md ${
            isFromAdmin 
                ? 'bg-gradient-to-br from-primary-500 to-secondary-500 text-white rounded-br-sm'
                : 'bg-gradient-to-br from-blue-50 to-blue-100 text-blue-900 rounded-bl-sm'
        }`;
        
        const senderLabel = isFromAdmin && adminName 
            ? `<div class="font-bold mb-2 text-xs uppercase tracking-wide opacity-90">${escapeHtml(adminName)}</div>`
            : !isFromAdmin 
                ? `<div class="font-bold mb-2 text-xs uppercase tracking-wide opacity-75">${escapeHtml(currentUserName)}</div>`
                : '';
        
        messageDiv.innerHTML = `
            ${senderLabel}
            <div class="text-sm leading-relaxed">${escapeHtml(text)}</div>
            <div class="text-xs opacity-70 text-right mt-1">${timeStr}</div>
        `;
        
        messageWrapper.appendChild(avatar);
        messageWrapper.appendChild(messageDiv);
        container.appendChild(messageWrapper);
        container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function updateChatPreview(sessionId, message) {
        const chatItem = document.querySelector(`[data-session-id="${sessionId}"] .truncate`);
        if (chatItem) {
            chatItem.textContent = message.length > 30 ? message.substring(0, 30) + '...' : message;
        }
    }
</script>
{% endblock %}